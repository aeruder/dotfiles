#!/bin/sh

DEFAULT_URL=http://www.google.com
HOST="`hostname`"
case "$HOST" in
    andrewruder-hplin)
        ip="`dig +short andyproxy.dci.local`"
        unset all_proxy
        unset http_proxy
        unset https_proxy
        unset ftp_proxy
        export no_proxy=elecsys-git,elecsys-web,10.63.\*,elecsys-\*
        export SOCKS_SERVER="$ip:5555"
        export SOCKS_VERSION=5
        ;;
esac

url="$1"

browser=
for a in google-chrome chromium firefox iceweasel ; do
    if which "$a"; then
        browser="$a"
        break
    fi
done
if [ -z "$browser" ]; then
    echo "No web browsers found"
    exit 1
fi

find_class() {
    found=
    class="$1"
    for line in `xdotool search --classname "$class"`; do
        if xprop -id "$line" | grep -q '^_NET_WM_DESKTOP('; then
            found="$line"
            break
        fi
    done
}

case "$browser" in
    google-chrome)
        if [ -z "$url" ]; then
            find_class '^Google-chrome$'
            if [ x"$found" != x ]; then
                exec xdotool windowactivate "$found"
            else
                url="$DEFAULT_URL"
            fi
        fi
        exec google-chrome "$url"
        ;;
    chromium)
        if [ -z "$url" ]; then
            find_class '^Chromium$'
            if [ x"$found" != x ]; then
                exec xdotool windowactivate "$found"
            else
                url="$DEFAULT_URL"
            fi
        fi
        exec chromium "$url"
        ;;
    firefox)
        if [ -z "$url" ]; then
            url="$DEFAULT_URL"
        fi
        exec firefox --new-tab "$url"
        ;;
    iceweasel)
        if [ -z "$url" ]; then
            url="$DEFAULT_URL"
        fi
        exec iceweasel --new-tab "$url"
        ;;
esac
