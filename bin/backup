#!/bin/sh

host="`hostname`"

remove_older=2W
dir="`dirname "$0"`/../backups"
incfile="$dir"/"$host".inc
excfile="$dir"/"$host".exc
destdir=backups::/external/backups/"$host"
uid="`id -u`"

if [ "$uid" = 0 ]; then
    cmd=(sudo rdiff-backup)
else
    cmd=(rdiff-backup)
fi

case "$host" in
    andrewruder-hplin)
        remove_older=30D
        ;;
    babombpi2|wheee|tanooki|kberry-pi)
        ;;
    *)
        echo "Enable backups for this host ($host) by editing $0" >&2
        exit 1
esac

if ! [ -e "$incfile" ] || ! [ -e "$excfile" ]; then
    echo "$incfile and $excfile don't exist!" >&2
    exit 1
fi

"${cmd[@]}" --print-statistics --terminal-verbosity 2 \
    --exclude-globbing-filelist "$excfile" \
    --include-globbing-filelist "$incfile" \
    --exclude / / "$destdir"
"${cmd[@]}" --remove-older-than "$remove_older" "$destdir"
